# Ekb_UrFU_SBER_GoodMorning_2025
Разработка алгоритма визуальной навигации в условиях малого вычислительного ресурса
Техническая документация
Система детекции объектов для БПЛА
1. Архитектура системы
    A [Входное видео] --> B [Обработка кадра]
    B --> C [Отслеживание движения камеры]
    B --> D [Детекция объектов]
    C --> E [Глобальная система координат]
    D --> F [Локализация объектов]
    E --> F [Локализация объектов]
    F --> G [Накопление координат]
    G --> H [Кластеризация DBSCAN]
    H --> I [Карта объектов]
2. Детекция объектов
Алгоритм обработки изображения:
def detect_objects(self, frame):
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    binary = cv2.adaptiveThreshold(gray, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, 
                                   cv2.THRESH_BINARY_INV, 11, 2)
    kernel = np.ones((3, 3), np.uint8)
    processed = cv2.morphologyEx(binary, cv2.MORPH_OPEN, kernel)
    processed = cv2.morphologyEx(processed, cv2.MORPH_CLOSE, kernel)
    contours, _ = cv2.findContours(processed, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    valid_contours = [cnt for cnt in contours if min_area < cv2.contourArea(cnt) < max_area]
    return valid_contours
Ключевые этапы:
Адаптивная бинаризация:
•	Использует гауссово среднее в окрестности 11×11 пикселей
•	Инвертированный порог (THRESH_BINARY_INV) для выделения темных объектов
•	Формула: pixel = 255 if pixel < mean - 2 else 0
Морфологические операции:
•	Открытие (морфологическое): Удаление мелких шумов
•	Закрытие (морфологическое): Заполнение мелких отверстий
•	Ядро 3×3 пикселя
Поиск контуров:
•	Режим RETR_EXTERNAL: Только внешние контуры
•	Метод аппроксимации CHAIN_APPROX_SIMPLE: Сжатое представление
Фильтрация контуров:
•	Минимальная площадь: 100 пикселей
•	Максимальная площадь: 10,000 пикселей
•	Отсев слишком мелких и крупных объектов
3. Отслеживание движения камеры
Алгоритм оптического потока:
def track_camera_movement(self, prev_frame, curr_frame):
    prev_pts = cv2.goodFeaturesToTrack(prev_frame, maxCorners=200,
                                       qualityLevel=0.01, minDistance=30, blockSize=3)
    curr_pts, status, _ = cv2.calcOpticalFlowPyrLK(prev_frame, curr_frame, prev_pts, None)
    H, _ = cv2.estimateAffinePartial2D(valid_prev, valid_curr)
    H_full = np.vstack([H, [0, 0, 1]])
    return H_full
Параметры и методы:
Выбор точек отслеживания:
•	Алгоритм Shi-Tomasi (goodFeaturesToTrack)
•	Качество точек: 0.01 (1% лучших точек)
•	Минимальное расстояние: 30 пикселей
Оптический поток Лукаса-Канаде:
•	Пирамидальная реализация (PyrLK)
•	Размер окна: 15×15 пикселей
•	Уровни пирамиды: 2
•	Критерии остановки: 10 итераций или точность 0.03
Оценка движения:
•	Аффинное преобразование (estimateAffinePartial2D)
•	Учитывает: Сдвиг, вращение, масштабирование
•	Минимальное требование: 5 точек соответствия
Накопление преобразований:
self.accumulated_homography = self.accumulated_homography @ H
•	Матричное умножение для композиции преобразований
•	Построение глобальной системы координат
4. Система координат и трансформация
Преобразование координат объектов:
global_point = self.accumulated_homography @ np.array([cx, cy, 1])
global_point /= global_point[2]  # Нормализация
Матрица гомографии:
 [ h11  h12  h13 ]
[ h21  h22  h23 ]
[ 0    0    1   ]
•	h11, h22: Масштабирование
•	h12, h21: Сдвиг/вращение
•	h13, h23: Трансляция
•	Нормализация: Перевод из однородных координат в декартовы
Визуализация:
•	Контуры объектов: Зеленый (0,255,0)
•	Центры масс: Красные точки (0,0,255)
•	Текст координат: Белый (255,255,255)
5. Постобработка координат
Алгоритм кластеризации DBSCAN:
def postprocess_coordinates(self):
    coords = np.array(self.global_coordinates)
    db = DBSCAN(eps=50, min_samples=1).fit(coords)
    for label in set(db.labels_):
        cluster_points = coords[db.labels_ == label]
        mean_coord = np.mean(cluster_points, axis=0)
        clustered_coords.append(mean_coord)
    self.global_coordinates = clustered_coords
Параметры DBSCAN:
•	eps=50: Максимальное расстояние между точками кластера (пиксели)
•	min_samples=1: Минимальное количество точек для образования кластера
•	Метрика расстояния: Евклидово расстояние по умолчанию
Обработка результатов:
•	Удаление шума (label = -1 не обрабатывается)
•	Усреднение координат внутри кластера
•	Сохранение только усредненных координат
6. Фильтры и их параметры
1. Адаптивный пороговый фильтр:
•	Тип: Гауссово среднее
•	Размер блока: 11×11 пикселей
•	Константа вычитания: 2
•	Назначение: Выделение темных объектов на светлом фоне
2. Морфологические фильтры:
•	Открытие: Удаление шумов (белый шум на черном фоне)
•	Закрытие: Заполнение отверстий в объектах
•	Ядро: 3×3 квадратное
•	3. Фильтр оптического потока:
•	Пирамидальный Лукас-Канаде
•	Весовое окно Гаусса: 15×15
•	Уровни пирамиды: 2
4. Геометрический фильтр контуров:
•	Площадь: 100 < area < 10,000 пикселей
•	Отсев артефактов и слишком крупных элементов
5. Пространственный фильтр DBSCAN:
•	Радиус кластеризации: 50 пикселей
•	Минимальный размер кластера: 1 точка
•	Назначение: Устранение дубликатов от многократной детекции

7. Поток обработки видео
Основной цикл:
while True:
    ret, frame = cap.read()
    curr_gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    
    # Отслеживание движения
    H = self.track_camera_movement(prev_gray, curr_gray)
    self.accumulated_homography @= H
    
    # Детекция объектов
    contours = self.detect_objects(frame)
    
    # Обработка объектов
    for cnt in contours:
        cx, cy = calculate_centroid(cnt)
        global_point = self.accumulated_homography @ [cx, cy, 1]
        self.global_coordinates.append(global_point[:2])
        draw_visualization(frame, cnt, cx, cy, global_point)
    
    out.write(frame)
    prev_gray = curr_gray.copy()
Особенности реализации:
Эффективность:
•	Работа с grayscale для оптического потока
•	Обработка только значимых контуров
Точность:
•	Компенсация движения камеры
•	Накопление преобразований с матричным умножением
Устойчивость:
•	Проверка статуса оптического потока
•	Обработка ошибок вычисления матрицы
8. Выходные данные и формат
Файл координатной карты:
Объектная карта координат (относительно точки взлета):
X       Y
1205    843
3056    1280
-845    2560
Структура данных:
•	Заголовок с описанием системы координат
•	Таблица координат в формате TSV (X\tY)
•	Координаты целочисленные (пиксели)
Интерпретация координат:
•	Начало координат: Первый кадр видео
•	Ось X: Горизонтальное направление
•	Ось Y: Вертикальное направление
•	Единица измерения: Пиксели (относительные)


9. Ограничения и рекомендации
Текущие ограничения:
1.	Зависимость от контраста объектов
2.	Нет трекинга отдельных объектов между кадрами
3.	Относительная система координат без привязки к GPS
Калибровка параметров:
Параметр	Значение	Направление оптимизации
min_area	100	Зависит от высоты полета
max_area	10000	Зависит от размера объектов
eps (DBSCAN)	50	Зависит от плотности объектов
qualityLevel	0.01	Увеличение для стабильности
winSize (LK)	15	Увеличение для плавного движения

